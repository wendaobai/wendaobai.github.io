import{_ as a,c as n,o as t,e as l,d as s}from"./app.58766e8b.js";const e="/assets/image-20230316144020838.23f22e4c.png",p="/assets/image-20230317104438268.68231c8a.png",o="/assets/image-20230321105409718.049ed495.png",r="/assets/image-20230321152631863.6282010b.png",c="/assets/image-20230321152718028.34dd8ab4.png",i="/assets/image-20230321152956266.b4945e87.png",y="/assets/image-20230321153514596.0ef33a0a.png",v=JSON.parse('{"title":"nginx","description":"","frontmatter":{},"headers":[{"level":2,"title":"什么是Nginx","slug":"什么是nginx","link":"#什么是nginx","children":[]},{"level":2,"title":"安装","slug":"安装","link":"#安装","children":[]},{"level":2,"title":"目录列表","slug":"目录列表","link":"#目录列表","children":[]},{"level":2,"title":"配置","slug":"配置","link":"#配置","children":[{"level":3,"title":"配置文件语法","slug":"配置文件语法","link":"#配置文件语法","children":[]},{"level":3,"title":"全局配置","slug":"全局配置","link":"#全局配置","children":[]},{"level":3,"title":"事件配置","slug":"事件配置","link":"#事件配置","children":[]},{"level":3,"title":"http配置","slug":"http配置","link":"#http配置","children":[]},{"level":3,"title":"server配置","slug":"server配置","link":"#server配置","children":[]}]},{"level":2,"title":"Systemd进程管理","slug":"systemd进程管理","link":"#systemd进程管理","children":[]},{"level":2,"title":"nginx日志","slug":"nginx日志","link":"#nginx日志","children":[]},{"level":2,"title":"nginx工作流","slug":"nginx工作流","link":"#nginx工作流","children":[]},{"level":2,"title":"核心功能","slug":"核心功能","link":"#核心功能","children":[{"level":3,"title":"监控客户端状态","slug":"监控客户端状态","link":"#监控客户端状态","children":[]},{"level":3,"title":"随机访问主页","slug":"随机访问主页","link":"#随机访问主页","children":[]},{"level":3,"title":"内容替换","slug":"内容替换","link":"#内容替换","children":[]}]},{"level":2,"title":"常见应用","slug":"常见应用","link":"#常见应用","children":[]},{"level":2,"title":"静态web服务器","slug":"静态web服务器","link":"#静态web服务器","children":[{"level":3,"title":"静态服务与动态服务","slug":"静态服务与动态服务","link":"#静态服务与动态服务","children":[]},{"level":3,"title":"CDN","slug":"cdn","link":"#cdn","children":[]},{"level":3,"title":"配置语法","slug":"配置语法","link":"#配置语法","children":[]}]},{"level":2,"title":"nginx缓存","slug":"nginx缓存","link":"#nginx缓存","children":[{"level":3,"title":"客户端缓存","slug":"客户端缓存","link":"#客户端缓存","children":[]}]},{"level":2,"title":"跨域设置","slug":"跨域设置","link":"#跨域设置","children":[]},{"level":2,"title":"代理服务","slug":"代理服务","link":"#代理服务","children":[{"level":3,"title":"正向代理","slug":"正向代理","link":"#正向代理","children":[]},{"level":3,"title":"方向代理","slug":"方向代理","link":"#方向代理","children":[]},{"level":3,"title":"proxy_pass","slug":"proxy-pass","link":"#proxy-pass","children":[]},{"level":3,"title":"负载均衡","slug":"负载均衡","link":"#负载均衡","children":[]}]},{"level":2,"title":"16. 缓存","slug":"_16-缓存","link":"#_16-缓存","children":[]},{"level":2,"title":"location","slug":"location","link":"#location","children":[{"level":3,"title":"1 正则表达式","slug":"_1-正则表达式","link":"#_1-正则表达式","children":[]},{"level":3,"title":"2 语法规则","slug":"_2-语法规则","link":"#_2-语法规则","children":[]},{"level":3,"title":"3 匹配规则","slug":"_3-匹配规则","link":"#_3-匹配规则","children":[]},{"level":3,"title":"4 案例","slug":"_4-案例","link":"#_4-案例","children":[]}]},{"level":2,"title":"18. rewrite","slug":"_18-rewrite","link":"#_18-rewrite","children":[{"level":3,"title":"18.1 用途","slug":"_18-1-用途","link":"#_18-1-用途","children":[]},{"level":3,"title":"18.2 语法","slug":"_18-2-语法","link":"#_18-2-语法","children":[]},{"level":3,"title":"18.3 flag","slug":"_18-3-flag","link":"#_18-3-flag","children":[]}]}],"relativePath":"前端运维/nginx.md"}'),D={name:"前端运维/nginx.md"},C=l('<h1 id="nginx" tabindex="-1">nginx <a class="header-anchor" href="#nginx" aria-hidden="true">#</a></h1><h2 id="什么是nginx" tabindex="-1">什么是Nginx <a class="header-anchor" href="#什么是nginx" aria-hidden="true">#</a></h2><ul><li>优势 <ul><li>高并发，高新能</li><li>扩展性好，热部署</li><li>可靠性高，开源许可</li></ul></li><li>应用场景 <ul><li>静态资源服务器</li><li>APi接口服务</li><li>反向代理</li></ul></li></ul><img src="'+e+`" alt="image-20230316144020838" style="zoom:50%;"><h2 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-hidden="true">#</a></h2><p>依赖模块安装</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">yum</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gcc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gcc-c++</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">autoconf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pcre</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pcre-devel</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">automake</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">openssl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">openssl-devel</span></span>
<span class="line"><span style="color:#FFCB6B;">yum</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">//安装nginx</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-v</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">//查看安装的版本</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-V</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">//查看编译时的参数</span></span>
<span class="line"></span></code></pre></div><h2 id="目录列表" tabindex="-1">目录列表 <a class="header-anchor" href="#目录列表" aria-hidden="true">#</a></h2><p>查看目录列表</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">rpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-ql</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"></span></code></pre></div><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"></span>
<span class="line"></span></code></pre></div><table><thead><tr><th>模块</th><th>目录</th><th>用途</th></tr></thead><tbody><tr><td>配置目录</td><td>/etc/nginx/nginx.conf</td><td>核心配置文件</td></tr><tr><td></td><td>/etc/nginx/conf.d/default.conf</td><td>默认http服务器配置文件</td></tr><tr><td>文档手册</td><td>/usr/share/doc/nginx-1.14.2</td><td>帮助文档</td></tr><tr><td></td><td>/usr/share/doc/nginx-1.14.0/COPYRIGHT</td><td>版权声明</td></tr><tr><td></td><td>/usr/share/man/man8/nginx.8.gz</td><td>手册</td></tr><tr><td>缓存目录</td><td>/var/cache/nginx</td><td>nginx的缓存目录</td></tr><tr><td>日志目录</td><td>/var/log/nginx</td><td>nginx的日志目录</td></tr><tr><td>可执行文件</td><td>/usr/sbin/nginx</td><td>可执行命令</td></tr><tr><td></td><td>/usr/sbin/nginx-debug</td><td>调试执行可执行命令</td></tr><tr><td>模块目录</td><td>/etc/nginx/modules</td><td>最基本的共享库和内核模块,</td></tr><tr><td>日志切割</td><td>/etc/logrotate.d/nginx</td><td>对访问日志进行切割</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h2 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-hidden="true">#</a></h2><ul><li>/etc/nginx/nginx.conf #主配置文件</li><li>/etc/nginx/conf.d/*.conf #包含conf.d目录下面的所有配置文件</li><li>/etc/nginx/conf.d/default.conf</li></ul><h3 id="配置文件语法" tabindex="-1">配置文件语法 <a class="header-anchor" href="#配置文件语法" aria-hidden="true">#</a></h3><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 使用#可以添加注释,使用$符号可以使用变量</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 配置文件由指令与指令块组成,指令块以{}将多条指令组织在一起</span></span>
<span class="line"><span style="color:#C792EA;">http</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># include语句允许把多个配置文件组合起来以提升可维护性    </span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> include </span><span style="color:#A6ACCD;">      mime.types</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 每条指令以;(分号)结尾，指令与参数之间以空格分隔</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> default_type </span><span style="color:#A6ACCD;"> application/octet-stream</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> sendfile </span><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;"> on;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> keepalive_timeout </span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">65</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">server</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> listen </span><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">80</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> server_name </span><span style="color:#A6ACCD;"> localhost</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 有些指令可以支持正则表达式        </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">  html</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;"> index </span><span style="color:#A6ACCD;"> index.html index.htm</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> error_page </span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">500</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">502</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">503</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">504</span><span style="color:#A6ACCD;">  /50x.html</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/50x.html </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">  html</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="全局配置" tabindex="-1">全局配置 <a class="header-anchor" href="#全局配置" aria-hidden="true">#</a></h3><table><thead><tr><th style="text-align:left;">分类</th><th style="text-align:left;">配置项</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">全局</td><td style="text-align:left;">user</td><td style="text-align:left;">设置nginx服务的系统使用用户</td></tr><tr><td style="text-align:left;">全局</td><td style="text-align:left;">worker_processes</td><td style="text-align:left;">工作进程数,一般和CPU数量相同</td></tr><tr><td style="text-align:left;">全局</td><td style="text-align:left;">error_log</td><td style="text-align:left;">nginx的错误日志</td></tr><tr><td style="text-align:left;">全局</td><td style="text-align:left;">pid</td><td style="text-align:left;">nginx服务启动时的pid</td></tr></tbody></table><h3 id="事件配置" tabindex="-1">事件配置 <a class="header-anchor" href="#事件配置" aria-hidden="true">#</a></h3><table><thead><tr><th style="text-align:left;">分类</th><th style="text-align:left;">配置项</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">events</td><td style="text-align:left;">worker_connections</td><td style="text-align:left;">每个进程允许的最大连接数 10000</td></tr><tr><td style="text-align:left;">events</td><td style="text-align:left;">use</td><td style="text-align:left;">指定使用哪种模型(select/poll/epoll),建议让nginx自动选择,linux内核2.6以上一般能使用epoll可以提高性能</td></tr></tbody></table><h3 id="http配置" tabindex="-1">http配置 <a class="header-anchor" href="#http配置" aria-hidden="true">#</a></h3><p>一个HTTP下面可以配置多个server</p><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">#全局配置</span></span>
<span class="line"><span style="color:#89DDFF;">user </span><span style="color:#A6ACCD;"> nginx</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">#设置nginx服务的系统使用用户  </span></span>
<span class="line"><span style="color:#89DDFF;">worker_processes </span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#工作进程数,一般和CPU数量相同 </span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">error_log </span><span style="color:#A6ACCD;"> /var/log/nginx/error.log</span><span style="color:#89DDFF;"> warn;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">#nginx的错误日志  </span></span>
<span class="line"><span style="color:#89DDFF;">pid </span><span style="color:#A6ACCD;">       /var/run/nginx.pid</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">#nginx服务启动时的pid</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#事件</span></span>
<span class="line"><span style="color:#C792EA;">events</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> worker_connections </span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1024</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">#每个进程允许的最大连接数 10000</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> use </span><span style="color:#A6ACCD;">epoll</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 使用轮训模式</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">http</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> include </span><span style="color:#A6ACCD;">      /etc/nginx/mime.types</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#文件后缀和类型类型的对应关系</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> default_type </span><span style="color:#A6ACCD;"> application/octet-stream</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 默认content-type</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> log_format  main</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">remote_addr</span><span style="color:#C3E88D;"> - </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">remote_user</span><span style="color:#C3E88D;"> [</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">time_local</span><span style="color:#C3E88D;">] &quot;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">request</span><span style="color:#C3E88D;">&quot; &#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">status</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">body_bytes_sent</span><span style="color:#C3E88D;"> &quot;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">http_referer</span><span style="color:#C3E88D;">&quot; &#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">                      </span><span style="color:#C3E88D;">&#39;&quot;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">http_user_agent</span><span style="color:#C3E88D;">&quot; &quot;</span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">http_x_forwarded_for</span><span style="color:#C3E88D;">&quot;&#39;</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 日志记录格式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> access_log </span><span style="color:#A6ACCD;"> /var/log/nginx/access.log </span><span style="color:#89DDFF;"> main;</span><span style="color:#676E95;font-style:italic;">#默认访问日志</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> sendfile </span><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;"> on;</span><span style="color:#676E95;font-style:italic;"># sendfile</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">#tcp_nopush     on;//懒发送</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> keepalive_timeout </span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">65</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">#超时时间是65秒</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> gzip  on;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 启用gzip压缩</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> include </span><span style="color:#A6ACCD;">/etc/nginx/conf.d/*.conf</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">#包含的子配置文件</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="server配置" tabindex="-1">server配置 <a class="header-anchor" href="#server配置" aria-hidden="true">#</a></h3><p>一个<code>server</code>下面可以包含多个<code>location</code></p><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">server</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> listen </span><span style="color:#A6ACCD;">      </span><span style="color:#F78C6C;">80</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#监听的端口号</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> server_name </span><span style="color:#A6ACCD;"> localhost</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#用域名方式访问的地址</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">#charset koi8-r; #编码</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">#access_log  /var/log/nginx/host.access.log  main;#访问日志文件和名称</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">  /usr/share/nginx/html</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#静态文件根目录</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;"># alias /user/share/nginx/html;#别名静态文件目录</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> index </span><span style="color:#A6ACCD;"> index.html index.htm</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#首页的索引文件</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">#error_page  404              /404.html;  #指定错误页面</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># redirect server error pages to the static page /50x.html</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 把后台错误重定向到静态的50x.html页面</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> error_page </span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">500</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">502</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">503</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">504</span><span style="color:#A6ACCD;">  /50x.html</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/50x.html </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">  /usr/share/nginx/html</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="systemd进程管理" tabindex="-1">Systemd进程管理 <a class="header-anchor" href="#systemd进程管理" aria-hidden="true">#</a></h2><ul><li>系统启动和服务器守护进程管理器，负责在系统启动或运行时，激活系统资源，服务器进程和其他进程，根据管理，字母d是守护进程（daemon）的缩写</li></ul><h4 id="systemctl" tabindex="-1">systemctl <a class="header-anchor" href="#systemctl" aria-hidden="true">#</a></h4><ul><li>监视和控制systemd的主要命令是systemctl</li><li>该命令可用于查看系统状态和管理系统及服务</li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">命令：systemctl  command name</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">service</span></span>
<span class="line"><span style="color:#A6ACCD;">启动：service name start –</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">systemctl start name</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">service</span></span>
<span class="line"><span style="color:#A6ACCD;">停止：service name stop –</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">systemctl stop name</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">service</span></span>
<span class="line"><span style="color:#A6ACCD;">重启：service name restart–</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">systemctl restart name</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">service</span></span>
<span class="line"><span style="color:#A6ACCD;">状态：service name status–</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">systemctl status name</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">service</span></span>
<span class="line"></span></code></pre></div><h4 id="启动和重新加载" tabindex="-1">启动和重新加载 <a class="header-anchor" href="#启动和重新加载" aria-hidden="true">#</a></h4><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">systemctl restart nginx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">service</span></span>
<span class="line"><span style="color:#A6ACCD;">systemctl reload nginx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">service</span></span>
<span class="line"><span style="color:#A6ACCD;">nginx </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">s reload</span></span>
<span class="line"></span></code></pre></div><h2 id="nginx日志" tabindex="-1">nginx日志 <a class="header-anchor" href="#nginx日志" aria-hidden="true">#</a></h2><h2 id="nginx工作流" tabindex="-1">nginx工作流 <a class="header-anchor" href="#nginx工作流" aria-hidden="true">#</a></h2><ul><li>请求到来时先按域名找到<code>server</code>块</li><li>再按请求路径找到<code>location</code>块</li><li><code>Context</code>是指本指令出现在哪个块内</li></ul><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">main</span></span>
<span class="line"><span style="color:#A6ACCD;">http</span><span style="color:#F07178;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">upstream</span><span style="color:#F07178;"> {}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">server</span><span style="color:#F07178;"> {</span></span>
<span class="line"><span style="color:#F07178;">        if(){}</span></span>
<span class="line"><span style="color:#F07178;">        location{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">        }</span></span>
<span class="line"><span style="color:#F07178;">        location{</span></span>
<span class="line"><span style="color:#F07178;">            location{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">            }</span></span>
<span class="line"><span style="color:#F07178;">        }</span></span>
<span class="line"><span style="color:#F07178;">    }</span></span>
<span class="line"><span style="color:#F07178;">    server{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">    }</span></span>
<span class="line"><span style="color:#F07178;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="server匹配" tabindex="-1">server匹配 <a class="header-anchor" href="#server匹配" aria-hidden="true">#</a></h4><h4 id="http处理流程" tabindex="-1">http处理流程 <a class="header-anchor" href="#http处理流程" aria-hidden="true">#</a></h4><table><thead><tr><th style="text-align:left;">阶段</th><th style="text-align:left;">名称</th><th style="text-align:left;">对应模块</th></tr></thead><tbody><tr><td style="text-align:left;">读取请求后</td><td style="text-align:left;">POST_READ</td><td style="text-align:left;">realip</td></tr><tr><td style="text-align:left;">重写</td><td style="text-align:left;">SERVER_REWRITE</td><td style="text-align:left;">rewrite</td></tr><tr><td style="text-align:left;">匹配location</td><td style="text-align:left;">FIND_CONFIG</td><td style="text-align:left;">rewrite</td></tr><tr><td style="text-align:left;">重写</td><td style="text-align:left;">REWRITE</td><td style="text-align:left;">rewrite</td></tr><tr><td style="text-align:left;">重写后</td><td style="text-align:left;">POST_REWRITE</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">访问前限制</td><td style="text-align:left;">PREACCESS</td><td style="text-align:left;">limit_conn,limit_req</td></tr><tr><td style="text-align:left;">是否有权限访问</td><td style="text-align:left;">ACCESS</td><td style="text-align:left;">auth_basic,access,auth_request</td></tr><tr><td style="text-align:left;">判断权限后</td><td style="text-align:left;">POST_ACCESS</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">响应前</td><td style="text-align:left;">PRECONTENT</td><td style="text-align:left;">try_files</td></tr><tr><td style="text-align:left;">读取请求后</td><td style="text-align:left;">CONTENT</td><td style="text-align:left;">index,autoindex,concat</td></tr><tr><td style="text-align:left;">打印日志</td><td style="text-align:left;">LOG</td><td style="text-align:left;">access_log</td></tr></tbody></table><img src="`+p+`" alt="image-20230317104438268" style="zoom:50%;"><h2 id="核心功能" tabindex="-1">核心功能 <a class="header-anchor" href="#核心功能" aria-hidden="true">#</a></h2><h3 id="监控客户端状态" tabindex="-1">监控客户端状态 <a class="header-anchor" href="#监控客户端状态" aria-hidden="true">#</a></h3><p>systemctl reload nginx.service</p><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">server</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/status</span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">stub_status</span><span style="color:#A6ACCD;">   on</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">systemctl reload nginx.service</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">http://192.171.207.104/status</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">Active connections: 2            </span></span>
<span class="line"><span style="color:#A6ACCD;">server accepts handled requests  </span></span>
<span class="line"><span style="color:#A6ACCD;"> 3 3 10 </span></span>
<span class="line"><span style="color:#A6ACCD;">Reading: 0 Writing: 1 Waiting: 1 </span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">Active connections</td><td style="text-align:left;">当前nginx正在处理的活动连接数</td></tr><tr><td style="text-align:left;">accepts</td><td style="text-align:left;">总共处理的连接数</td></tr><tr><td style="text-align:left;">handled</td><td style="text-align:left;">成功创建握手数</td></tr><tr><td style="text-align:left;">requests</td><td style="text-align:left;">总共处理请求数</td></tr><tr><td style="text-align:left;">Reading</td><td style="text-align:left;">读取到客户端的Header信息数</td></tr><tr><td style="text-align:left;">Writing</td><td style="text-align:left;">返回给客户端的Header信息数</td></tr><tr><td style="text-align:left;">Waiting</td><td style="text-align:left;">开启keep-alive的情况下,这个值等于 active – (reading + writing)</td></tr></tbody></table><h3 id="随机访问主页" tabindex="-1">随机访问主页 <a class="header-anchor" href="#随机访问主页" aria-hidden="true">#</a></h3><p>--with-http_random_index_module 在根目录里随机选择一个主页显示</p><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;"> root </span><span style="color:#A6ACCD;">/opt/app</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;"> random_index </span><span style="color:#A6ACCD;">on</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"></span></code></pre></div><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/opt/app</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/opt/app</span></span>
<span class="line"><span style="color:#FFCB6B;">ls</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">red</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">read.html</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yellow</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yellow.html</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">blue</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">blue.html</span></span>
<span class="line"></span></code></pre></div><h3 id="内容替换" tabindex="-1">内容替换 <a class="header-anchor" href="#内容替换" aria-hidden="true">#</a></h3><p>--with-http_sub_module 内容替换</p><h2 id="常见应用" tabindex="-1">常见应用 <a class="header-anchor" href="#常见应用" aria-hidden="true">#</a></h2><h2 id="静态web服务器" tabindex="-1">静态web服务器 <a class="header-anchor" href="#静态web服务器" aria-hidden="true">#</a></h2><h3 id="静态服务与动态服务" tabindex="-1">静态服务与动态服务 <a class="header-anchor" href="#静态服务与动态服务" aria-hidden="true">#</a></h3><ul><li>静态资源：一般客户端发送请求到web服务器，web服务器从内存在取到相应的文件，返回给客户端，客户端解析并渲染显示出来。</li><li>动态资源：一般客户端请求的动态资源，先将请求交于web容器，web容器连接数据库，数据库处理数据之后，将内容交给web服务器，web服务器返回给客户端解析渲染处理。</li></ul><h3 id="cdn" tabindex="-1">CDN <a class="header-anchor" href="#cdn" aria-hidden="true">#</a></h3><ul><li><p>CDN的全称是Content Delivery Network，即内容分发网络。</p></li><li><p>CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。</p></li><li><p>DN的全称是Content Delivery Network，即内容分发网络。</p></li><li><p>CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。</p></li></ul><p><a href="http://img.zhufengpeixun.cn/cdn.jpg" target="_blank" rel="noreferrer">cdn</a></p><h3 id="配置语法" tabindex="-1">配置语法 <a class="header-anchor" href="#配置语法" aria-hidden="true">#</a></h3><h4 id="_1-sendfile" tabindex="-1">1 sendfile <a class="header-anchor" href="#_1-sendfile" aria-hidden="true">#</a></h4><ul><li>不经过用户内核发送文件</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">sendfile on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">sendfile off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location,if in location</td></tr></tbody></table><h4 id="_2-tcp-nopush" tabindex="-1">2 tcp_nopush <a class="header-anchor" href="#_2-tcp-nopush" aria-hidden="true">#</a></h4><ul><li>在sendfile开启的情况下，合并多个数据包，提高网络包的传输效率</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">tcp_nopush on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">tcp_nopush off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_3-tcp-nodelay" tabindex="-1">3 tcp_nodelay <a class="header-anchor" href="#_3-tcp-nodelay" aria-hidden="true">#</a></h4><ul><li>在keepalive连接下，提高网络包的传输实时性</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">tcp_nodelay on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">tcp_nodelay on;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_4-gzip" tabindex="-1">4 gzip <a class="header-anchor" href="#_4-gzip" aria-hidden="true">#</a></h4><ul><li>压缩文件可以节约带宽和提高网络传输效率</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_5-gzip-comp-level" tabindex="-1">5 gzip_comp_level <a class="header-anchor" href="#_5-gzip-comp-level" aria-hidden="true">#</a></h4><ul><li>压缩比率越高，文件被压缩的体积越小</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip_comp_level level</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip_comp_level 1;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_6-gzip-http-version" tabindex="-1">6 gzip_http_version <a class="header-anchor" href="#_6-gzip-http-version" aria-hidden="true">#</a></h4><ul><li>压缩版本</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip_http_version 1.0/1.1</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip_http_version 1.1;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_7-http-gzip-static-module" tabindex="-1">7 http_gzip-static_module <a class="header-anchor" href="#_7-http-gzip-static-module" aria-hidden="true">#</a></h4><ul><li>先找磁盘上找同名的<code>.gz</code>这个文件是否存在,节约CPU的压缩时间和性能损耗</li><li><code>http_gzip_static_module</code> 预计gzip模块</li><li><code>http_gunzip_module</code> 应用支持gunzip的压缩方式</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip_static on/off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip_static off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h2 id="nginx缓存" tabindex="-1">nginx缓存 <a class="header-anchor" href="#nginx缓存" aria-hidden="true">#</a></h2><h3 id="客户端缓存" tabindex="-1">客户端缓存 <a class="header-anchor" href="#客户端缓存" aria-hidden="true">#</a></h3><ul><li>优先校验强缓存expires(分钟) cache-control(max-age秒级别)，cache-control优先级大于expires</li><li>然后校验协商缓存last-modified etag字段,eTag指纹效果比last-modified好</li></ul><img src="`+o+`" alt="image-20230321105409718" style="zoom:50%;"><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.*\\.(js|css)$ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> expires </span><span style="color:#A6ACCD;">10d</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">	add_header </span><span style="color:#A6ACCD;">   Cache-Control  max-age=3600</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}   </span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h2 id="跨域设置" tabindex="-1">跨域设置 <a class="header-anchor" href="#跨域设置" aria-hidden="true">#</a></h2><ul><li>跨域是指一个域下的文档或脚本试图去请求另一个域下的资源</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">add_header name value</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">add_header --;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/json</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/json</span></span>
<span class="line"><span style="color:#FFCB6B;">vi</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">user.json</span></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">zs</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#FFCB6B;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.</span><span style="color:#A6ACCD;">*</span><span style="color:#A6ACCD;">\\.</span><span style="color:#C3E88D;">json</span><span style="color:#A6ACCD;">$ </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">add_header</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Access-Control-Allow-Origin</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">http://127.0.0.1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">add_header</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Access-Control-Allow-Methods</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">GET,POST,PUT,DELETE,OPTIONS</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">root</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/data/json</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><p>index.html</p><div class="language-html"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F07178;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">HTML</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">PUBLIC</span><span style="color:#89DDFF;"> </span><span style="color:#C3E88D;">&quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> xhr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">XMLHttpRequest</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">GET</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http://115.29.148.6/user.json</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onreadystatechange</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">readyState</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">4</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">status</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">responseText</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><h2 id="代理服务" tabindex="-1">代理服务 <a class="header-anchor" href="#代理服务" aria-hidden="true">#</a></h2><p>相关配置</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">proxy_pass URL</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">server,location</td></tr></tbody></table><h3 id="正向代理" tabindex="-1">正向代理 <a class="header-anchor" href="#正向代理" aria-hidden="true">#</a></h3><ul><li>正向代理的对象是客户端,服务器端看不到真正的客户端</li><li>通过公司代理服务器上网</li></ul><img src="`+r+'" alt="image-20230321152631863" style="zoom:50%;"><h3 id="方向代理" tabindex="-1">方向代理 <a class="header-anchor" href="#方向代理" aria-hidden="true">#</a></h3><ul><li>反向代理的对象的服务端,客户端看不到真正的服务端</li><li>nginx代理应用服务器</li></ul><img src="'+c+`" alt="image-20230321152718028" style="zoom:50%;"><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">^/api </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_pass </span><span style="color:#A6ACCD;">http://localhost:3000</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_redirect </span><span style="color:#A6ACCD;">default</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#重定向</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_set_header </span><span style="color:#A6ACCD;">Host </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">http_host</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;">#向后传递头信息</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_set_header </span><span style="color:#A6ACCD;">X-Real-IP </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">remote_addr</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#把真实IP传给应用服务器</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_connect_timeout </span><span style="color:#A6ACCD;">30</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#默认超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_send_timeout </span><span style="color:#A6ACCD;">60</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 发送超时</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_read_timeout </span><span style="color:#A6ACCD;">60</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 读取超时</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_buffering </span><span style="color:#A6ACCD;">on</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">             </span><span style="color:#676E95;font-style:italic;"># 在proxy_buffering 开启的情况下，Nginx将会尽可能的读取所有的upstream端传输的数据到buffer，直到proxy_buffers设置的所有buffer们 被写满或者数据被读取完(EOF)</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_buffers </span><span style="color:#A6ACCD;">4 </span><span style="color:#F78C6C;">128k</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">           </span><span style="color:#676E95;font-style:italic;"># proxy_buffers由缓冲区数量和缓冲区大小组成的。总的大小为number*size</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_busy_buffers_size </span><span style="color:#A6ACCD;">256k</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;"># proxy_busy_buffers_size不是独立的空间，他是proxy_buffers和proxy_buffer_size的一部分。nginx会在没有完全读完后端响应的时候就开始向客户端传送数据，所以它会划出一部分缓冲区来专门向客户端传送数据(这部分的大小是由proxy_busy_buffers_size来控制的，建议为proxy_buffers中单个缓冲区大小的2倍)，然后它继续从后端取数据，缓冲区满了之后就写到磁盘的临时文件中。</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_buffer_size </span><span style="color:#A6ACCD;">32k</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;"># 用来存储upstream端response的header</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> proxy_max_temp_file_size </span><span style="color:#A6ACCD;">256k</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># response的内容很大的 话，Nginx会接收并把他们写入到temp_file里去，大小由proxy_max_temp_file_size控制。如果busy的buffer 传输完了会从temp_file里面接着读数据，直到传输完毕。</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">http://localhost/api/users.json</span></span>
<span class="line"></span></code></pre></div><h3 id="proxy-pass" tabindex="-1">proxy_pass <a class="header-anchor" href="#proxy-pass" aria-hidden="true">#</a></h3><ul><li>如果<code>proxy_pass</code>的<code>URL</code>定向里不包括<code>URI</code>，那么请求中的URI会保持原样传送给后端server</li><li>为了方便记忆和规范配置，建议所有的 proxy_pass 后的url都以<code>/</code>结尾</li><li><code>proxy_pass</code>后的url最后加上<code>/</code>就是绝对根路径，<code>location</code>中匹配的路径部分不走代理,也就是说会被替换掉</li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">proxy_pass</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//127.0.0.1/b/;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#FFCB6B;">请求http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//example.com/a/test.html 会被代理到http://127.0.0.1/b/test.html</span></span>
<span class="line"></span></code></pre></div><ul><li>如果<code>proxy_pass</code>的<code>URL</code>定向里不包括<code>URI</code>，那么请求中的URI会保持原样传送给后端server,如果没有/，表示相对路径</li><li><code>proxy_pass</code>后的url最后没有<code>/</code>就是相对路径，<code>location</code>中匹配的路径部分会走代理,也就是说会保留</li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">a</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">proxy_pass</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//127.0.0.1;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">请求http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//example/a/test.html 会被代理到http://127.0.0.1/a/test.html</span></span>
<span class="line"></span></code></pre></div><ul><li><p>在proxy_pass前面用了rewrite，如下，这种情况下，proxy_pass是无效的</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">getName</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">rewrite</span><span style="color:#F07178;">    </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">getName</span><span style="color:#89DDFF;">/</span><span style="color:#F07178;">([</span><span style="color:#89DDFF;">^/</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">+</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">users</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">$1</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">break</span><span style="color:#F07178;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">proxy_pass</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//127.0.0.1;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></li></ul><h3 id="负载均衡" tabindex="-1">负载均衡 <a class="header-anchor" href="#负载均衡" aria-hidden="true">#</a></h3><img src="`+i+`" alt="image-20230321152956266" style="zoom:50%;"><ul><li><p>使用集群是网站解决高并发、海量数据问题的常用手段。</p></li><li><p>当一台服务器的处理能力、存储空间不足时，不要企图去换更强大的服务器，对大型网站而言，不管多么强大的服务器，都满足不了网站持续增长的业务需求。</p></li><li><p>这种情况下，更恰当的做法是增加一台服务器分担原有服务器的访问及存储压力。通过负载均衡调度服务器，将来自浏览器的访问请求分发到应用服务器集群中的任何一台服务器上，如果有更多的用户，就在集群中加入更多的应用服务器，使应用服务器的负载压力不再成为整个网站的瓶颈。</p></li><li><p>nginx把请求转发到后台的一组<code>upstream</code>服务池</p></li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">upstream name {}</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http</td></tr></tbody></table><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">var</span><span style="color:#A6ACCD;"> http </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">( </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">var</span><span style="color:#A6ACCD;"> server </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">http</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createServer</span><span style="color:#A6ACCD;">( </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">request</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;font-style:italic;">response</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">){</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">end</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">server3 000</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">server</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">listen</span><span style="color:#A6ACCD;">( </span><span style="color:#F78C6C;">3000</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">function</span><span style="color:#89DDFF;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">( </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">HTTP服务器启动中，端口：3000</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">zhufeng </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000 </span><span style="color:#A6ACCD;font-style:italic;">weight</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  server 127.0.0.1:4000;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:5000;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">server</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">location</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">/ </span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> proxy_pass </span><span style="color:#A6ACCD;">http://zhufeng</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="服务状态" tabindex="-1">服务状态 <a class="header-anchor" href="#服务状态" aria-hidden="true">#</a></h4><table><thead><tr><th style="text-align:left;">状态</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">down</td><td style="text-align:left;">当前的服务器不参与负载均衡</td></tr><tr><td style="text-align:left;">backup</td><td style="text-align:left;">当其它节点都无法使用时的备份的服务器</td></tr><tr><td style="text-align:left;">max_fails</td><td style="text-align:left;">允许请求失败的次数,到达最大次数就会休眠</td></tr><tr><td style="text-align:left;">fail_timeout</td><td style="text-align:left;">经过max_fails失败后，服务暂停的时间,默认10秒</td></tr><tr><td style="text-align:left;">max_conns</td><td style="text-align:left;">限制每个server最大的接收的连接数,性能高的服务器可以连接数多一些</td></tr></tbody></table><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">upstream zfpx </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">localhost</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">3000</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">down</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">localhost</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">4000</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">backup</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">server</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">localhost</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">5000</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">max_fails</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">fail_timeout</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;">10</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="分配方式" tabindex="-1">分配方式 <a class="header-anchor" href="#分配方式" aria-hidden="true">#</a></h4><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">轮询(默认)</td><td style="text-align:left;">每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除</td></tr><tr><td style="text-align:left;">weight(加权轮询)</td><td style="text-align:left;">指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况</td></tr><tr><td style="text-align:left;">ip_hash</td><td style="text-align:left;">每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题</td></tr><tr><td style="text-align:left;">least_conn</td><td style="text-align:left;">哪个机器上连接数少就分发给谁</td></tr><tr><td style="text-align:left;">url_hash(第三方)</td><td style="text-align:left;">按访问的URL地址来分配 请求，每个URL都定向到同一个后端 服务器上(缓存)</td></tr><tr><td style="text-align:left;">fair(第三方)</td><td style="text-align:left;">按后端服务器的响应时间来分配请求，响应时间短的优先分配</td></tr><tr><td style="text-align:left;">正定义hash</td><td style="text-align:left;">hash自定义key</td></tr></tbody></table><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">zhufeng</span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">ip_hash;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">zhufeng</span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">least_conn;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">zhufeng</span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  url_hash;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">zhufeng</span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  fair;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#C792EA;">upstream</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">zhufeng</span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;"> hash $</span><span style="color:#A6ACCD;">request_uri</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">server</span><span style="color:#A6ACCD;"> 127.0.0.1:3000;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="_16-缓存" tabindex="-1">16. 缓存 <a class="header-anchor" href="#_16-缓存" aria-hidden="true">#</a></h2><ul><li>应用服务器端缓存</li><li>代理缓存</li><li>客户端缓存</li></ul><p><a href="https://blog.csdn.net/dengjiexian123/article/details/53386586" target="_blank" rel="noreferrer">proxy_cache</a></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">http</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#F07178;">    # </span><span style="color:#A6ACCD;">缓存路径</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">目录层级</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">缓存空间名称和大小</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">失效时间为7天</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">最大容量为10g</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">proxy_cache_path</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">nginx</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">cache</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">levels</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">:</span><span style="color:#F78C6C;">2</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">keys_zone</span><span style="color:#89DDFF;">=</span><span style="color:#FFCB6B;">cache</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;">100</span><span style="color:#A6ACCD;">m</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">inactive</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;">60</span><span style="color:#A6ACCD;">m</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">max_size</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;">10</span><span style="color:#A6ACCD;">g</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"></span></code></pre></div><table><thead><tr><th style="text-align:left;">键值</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">proxy_cache_path</td><td style="text-align:left;">缓存文件路径</td></tr><tr><td style="text-align:left;">levels</td><td style="text-align:left;">设置缓存文件目录层次；levels=1:2 表示两级目录</td></tr><tr><td style="text-align:left;">keys_zone</td><td style="text-align:left;">设置缓存名字和共享内存大小</td></tr><tr><td style="text-align:left;">inactive</td><td style="text-align:left;">在指定时间内没人访问则被删除</td></tr><tr><td style="text-align:left;">max_size</td><td style="text-align:left;">最大缓存空间，如果缓存空间满，默认覆盖掉缓存时间最长的资源</td></tr></tbody></table><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> ($request_uri </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">^</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">cache</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">(login</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">logout)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">set</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">$nocache</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    location </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#A6ACCD;">proxy_pass</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//zhufeng;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    location </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">^</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">cache</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#A6ACCD;">proxy_cache</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cache</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#A6ACCD;">proxy_cache_valid</span><span style="color:#F07178;">  </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">206</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">304</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">301</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">302</span><span style="color:#F07178;"> 60</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">   # </span><span style="color:#A6ACCD;">对哪些状态码缓存</span><span style="color:#F07178;">，</span><span style="color:#A6ACCD;">过期时间为60分钟</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#A6ACCD;">proxy_cache_key</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">$uri</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">  #</span><span style="color:#A6ACCD;">缓存的维度</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#A6ACCD;">proxy_no_cache</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">$nocache</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#A6ACCD;">proxy_set_header</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">Host</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">$host</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">$server_port</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">  #</span><span style="color:#A6ACCD;">设置头</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#A6ACCD;">proxy_set_header</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">X</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">Real</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">IP</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">$remote_addr</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">   #</span><span style="color:#A6ACCD;">设置头</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#A6ACCD;">proxy_set_header</span><span style="color:#F07178;">   </span><span style="color:#A6ACCD;">X</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">Forwarded</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">For</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">$proxy_add_x_forwarded_for</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">   #</span><span style="color:#A6ACCD;">设置头</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#A6ACCD;">proxy_pass</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//127.0.0.1:6000;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><table><thead><tr><th style="text-align:left;">键值</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">proxy_cache</td><td style="text-align:left;">使用名为cache的对应缓存配置</td></tr><tr><td style="text-align:left;">proxy_cache_valid 200 206 304 301 302 10d;</td><td style="text-align:left;">对httpcode为200的缓存10天</td></tr><tr><td style="text-align:left;">proxy_cache_key $uri</td><td style="text-align:left;">定义缓存唯一key,通过唯一key来进行hash存取</td></tr><tr><td style="text-align:left;">proxy_set_header</td><td style="text-align:left;">自定义http header头，用于发送给后端真实服务器</td></tr><tr><td style="text-align:left;">proxy_pass</td><td style="text-align:left;">指代理后转发的路径，注意是否需要最后的/</td></tr></tbody></table><h2 id="location" tabindex="-1">location <a class="header-anchor" href="#location" aria-hidden="true">#</a></h2><h3 id="_1-正则表达式" tabindex="-1">1 正则表达式 <a class="header-anchor" href="#_1-正则表达式" aria-hidden="true">#</a></h3>`,131),d=s("table",null,[s("thead",null,[s("tr",null,[s("th",{style:{"text-align":"left"}},"类型"),s("th",{style:{"text-align":"left"}},"种类")])]),s("tbody",null,[s("tr",null,[s("td",{style:{"text-align":"left"}},"."),s("td",{style:{"text-align":"left"}},"匹配除换行符之外的任意字符")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"?"),s("td",{style:{"text-align":"left"}},"重复0次或1次")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"+"),s("td",{style:{"text-align":"left"}},"重复1次或更多次")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"*"),s("td",{style:{"text-align":"left"}},"重复零次或多次")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"^"),s("td",{style:{"text-align":"left"}},"匹配字符串的开始")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"$"),s("td",{style:{"text-align":"left"}},"匹配字符串的结束")]),s("tr",null,[s("td",{style:{"text-align":"left"},n:""}),s("td",{style:{"text-align":"left"}},"重复n次")]),s("tr",null,[s("td",{style:{"text-align":"left"},"n,":""}),s("td",{style:{"text-align":"left"}},"重复n次或更多次")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"[abc]"),s("td",{style:{"text-align":"left"}},"匹配单个字符a或者b或者c")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"a-z"),s("td",{style:{"text-align":"left"}},"匹配a-z小写字母的任意一个")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"\\"),s("td",{style:{"text-align":"left"}},"转义字符")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"()"),s("td",{style:{"text-align":"left"}},"用于匹配括号之间的内容，可以通过$1、$2引用")]),s("tr",null,[s("td",{style:{"text-align":"left"}},"\\w"),s("td",{style:{"text-align":"left"}},"的释义都是指包含大 小写字母数字和下划线 相当于([0-9a-zA-Z])")])])],-1),F=l(`<h3 id="_2-语法规则" tabindex="-1">2 语法规则 <a class="header-anchor" href="#_2-语法规则" aria-hidden="true">#</a></h3><ul><li>location仅匹配URI，忽略参数</li><li>前缀字符串 <ul><li>常规</li><li>= 精确匹配</li><li>^~ 匹配上后则不再进行正则表达式的匹配</li></ul></li><li>正则表达式 <ul><li>~ 大小写敏感的正则表达式匹配</li><li>~*忽略大小写的正则表达式匹配</li></ul></li><li>内部调转 <ul><li>用于内部跳转的命名location @</li></ul></li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">Syntax location [</span><span style="color:#89DDFF;">=|~|~*|^~</span><span style="color:#A6ACCD;">] uri </span><span style="color:#89DDFF;">{...}</span></span>
<span class="line"><span style="color:#A6ACCD;">       location </span><span style="color:#89DDFF;">@</span><span style="color:#A6ACCD;">name</span><span style="color:#89DDFF;">{...}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span></span>
<span class="line"><span style="color:#A6ACCD;">Context server</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">location       </span></span>
<span class="line"></span></code></pre></div><h3 id="_3-匹配规则" tabindex="-1">3 匹配规则 <a class="header-anchor" href="#_3-匹配规则" aria-hidden="true">#</a></h3><ul><li>等号类型（=）的优先级最高。一旦匹配成功，则不再查找其他匹配项。</li><li>^~类型表达式。一旦匹配成功，则不再查找其他匹配项。</li><li>正则表达式类型（~ ~*）的优先级次之。如果有多个location的正则能匹配的话，则使用正则表达式最长的那个。</li><li>常规字符串匹配类型按前缀匹配</li></ul><img src="`+y+`" alt="image-20230321153514596" style="zoom:50%;"><h3 id="_4-案例" tabindex="-1">4 案例 <a class="header-anchor" href="#_4-案例" aria-hidden="true">#</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T1</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">$ </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">匹配到第一个正则表达式</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">~*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">T1</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">(\\w</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">)$ </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">匹配到最长的正则表达式</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">^~</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">T1</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">停止后续的正则表达式匹配</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location  </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T1</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T2 </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">最长的前缀表达式匹配</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location  </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T1 </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">前缀表达式匹配</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T1 </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">精确匹配</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T1     </span><span style="color:#676E95;font-style:italic;">//精确匹配</span></span>
<span class="line"><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">T1</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">//停止后续的正则表达式匹配</span></span>
<span class="line"><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T1</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T2  </span><span style="color:#676E95;font-style:italic;">//匹配到最长的正则表达式</span></span>
<span class="line"><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T1</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T2</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">//最长的前缀表达式匹配</span></span>
<span class="line"><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">t1</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">T2  </span><span style="color:#676E95;font-style:italic;">//匹配到最长的正则表达式</span></span>
<span class="line"></span></code></pre></div><h2 id="_18-rewrite" tabindex="-1">18. rewrite <a class="header-anchor" href="#_18-rewrite" aria-hidden="true">#</a></h2><ul><li>可以实现url重写及重定向</li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">syntax</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> rewrite regex replacement [flag]</span></span>
<span class="line"><span style="color:#FFCB6B;">Default</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> —</span></span>
<span class="line"><span style="color:#FFCB6B;">Context</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> server</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> location</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span></span>
<span class="line"></span></code></pre></div><ul><li>如果正则表达式（regex）匹配到了请求的URI（request URI），这个URI会被后面的replacement替换</li><li>rewrite的定向会根据他们在配置文件中出现的顺序依次执行</li><li>通过使用flag可以终止定向后进一步的处理</li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">rewrite </span><span style="color:#89DDFF;">^</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">users</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">.*</span><span style="color:#A6ACCD;">)$ </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">show</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;">user</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">$1</span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> last;</span><span style="color:#89DDFF;">=</span></span>
<span class="line"></span></code></pre></div><h3 id="_18-1-用途" tabindex="-1">18.1 用途 <a class="header-anchor" href="#_18-1-用途" aria-hidden="true">#</a></h3><ul><li>URL页面跳转</li><li>兼容旧版本</li><li>SEO优化(伪静态)</li><li>维护(后台维护、流量转发)</li><li>安全(伪静态)</li></ul><h3 id="_18-2-语法" tabindex="-1">18.2 语法 <a class="header-anchor" href="#_18-2-语法" aria-hidden="true">#</a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">rewrite regex replacement [flag]</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">server,location,if</td></tr></tbody></table><ul><li>regex 正则表达式指的是要被改写的路径</li><li>replacement 目标要替换成哪个URL</li><li>flag 标识</li></ul><p>实例</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">rewrite </span><span style="color:#89DDFF;">^</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">.*</span><span style="color:#A6ACCD;">)$ </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">www</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">reparing</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">html </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><h3 id="_18-3-flag" tabindex="-1">18.3 flag <a class="header-anchor" href="#_18-3-flag" aria-hidden="true">#</a></h3><ul><li>标志位是标识规则对应的类型</li></ul><table><thead><tr><th style="text-align:left;">flag</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">last</td><td style="text-align:left;">先匹配自己的location,然后通过rewrite规则新建一个请求再次请求服务端</td></tr><tr><td style="text-align:left;">break</td><td style="text-align:left;">先匹配自己的location,然后生命周期会在当前的location结束,不再进行后续的匹配</td></tr><tr><td style="text-align:left;">redirect</td><td style="text-align:left;">返回302昨时重定向,以后还会请求这个服务器</td></tr><tr><td style="text-align:left;">permanent</td><td style="text-align:left;">返回301永久重定向,以后会直接请求永久重定向后的域名</td></tr></tbody></table><h4 id="_18-3-1-last" tabindex="-1">18.3.1 last <a class="header-anchor" href="#_18-3-1-last" aria-hidden="true">#</a></h4><ul><li>结束当前的请求处理,用替换后的URI重新匹配<code>location</code></li><li>可理解为重写（rewrite）后，发起了一个新请求，进入server模块，匹配location</li><li>如果重新匹配循环的次数超过10次，nginx会返回500错误</li><li>返回302 http状态码</li><li>浏览器地址栏显示重定向后的url</li></ul><h4 id="_18-3-2-break" tabindex="-1">18.3.2 break <a class="header-anchor" href="#_18-3-2-break" aria-hidden="true">#</a></h4><ul><li>结束当前的请求处理，使用当前资源，不再执行location里余下的语句</li><li>返回302 http状态码</li><li>浏览器地址栏显示重定向后的url</li></ul><h4 id="_18-3-3-redirect" tabindex="-1">18.3.3 redirect <a class="header-anchor" href="#_18-3-3-redirect" aria-hidden="true">#</a></h4><ul><li>临时跳转，返回302 http状态码</li><li>浏览器地址栏显示重地向后的url</li></ul><h4 id="_18-3-4-permanent" tabindex="-1">18.3.4 permanent <a class="header-anchor" href="#_18-3-4-permanent" aria-hidden="true">#</a></h4><ul><li>永久跳转，返回301 http状态码；</li><li>浏览器地址栏显示重定向后的url</li></ul><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">^/</span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">rewrite</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">^/</span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">test</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">root</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">html</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">^/</span><span style="color:#A6ACCD;">last </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">rewrite</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">^/</span><span style="color:#A6ACCD;">last</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">test</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">last</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">test </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">default_type</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">application</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">json</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">{&quot;code&quot;:0,&quot;msg&quot;:&quot;success&quot;}</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">^/</span><span style="color:#A6ACCD;">redirect </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">rewrite</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">^/</span><span style="color:#A6ACCD;">redirect</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//www.baidu.com redirect;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">location </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">^/</span><span style="color:#A6ACCD;">permanent </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">rewrite</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">^/</span><span style="color:#A6ACCD;">permanent</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//www.baidu.com permanent;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">curl </span><span style="color:#FFCB6B;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//115.29.148.6/break</span></span>
<span class="line"><span style="color:#A6ACCD;">test</span></span>
<span class="line"><span style="color:#A6ACCD;">curl </span><span style="color:#FFCB6B;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//115.29.148.6/last</span></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">code</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">:</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">msg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">success</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">curl </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">vL </span><span style="color:#FFCB6B;">http</span><span style="color:#89DDFF;">:</span><span style="color:#676E95;font-style:italic;">//115.29.148.6/redirect</span></span>
<span class="line"><span style="color:#A6ACCD;">curl </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">vL http</span></span>
<span class="line"></span></code></pre></div>`,32),A=[C,d,F];function h(g,x,f,u,b,_){return t(),n("div",null,A)}const E=a(D,[["render",h]]);export{v as __pageData,E as default};
